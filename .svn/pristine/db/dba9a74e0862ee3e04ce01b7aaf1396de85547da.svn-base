#include <SDL.h>
#include <SDL_gfxPrimitives.h>
#include <math.h>
#include <stdlib.h>
#include "menu.h"
#include "game.h"

#define SCREEN_W 480
#define SCREEN_H 480


int main(int argc, char *argv[]) {
    SDL_Surface *screen;    //képernyõ
    SDL_Event event;        //esemeny
    koor *boxpos;           //a dobozok pozíciói
    koor charpos;           //a karakter pozíciója
    lab lab1;               //a labirintus adatai
    int game = 0;
    int ranking = 0;
    int quit = 0;
    int level;

    /* SDL inicializálása és ablak megnyitása */
    SDL_Init(SDL_INIT_VIDEO | SDL_INIT_TIMER);
    screen=SDL_SetVideoMode(SCREEN_W, SCREEN_H, 0, SDL_ANYFORMAT);
    if (!screen) {
        fprintf(stderr, "Nem sikerult megnyitni az ablakot!\n");
        exit(1);
    }
    SDL_WM_SetCaption("Fluttershy SOKOBAN", "Fluttershy SOKOBAN");

    /*Képek + betûtípus betöltése*/
    loadimages();       //játékhoz szükséges képek betöltése
    loadponystates();   //a póni animációjához szükséges képrészek eltárolása
    loadmenu();         //a menühöz tartozó képek betöltése
    loadranking();      //a rangsorhoz tartozó képek betöltése
    fontinit();         //betûtípus betöltése
    fontinit_r();

    //Program ciklus
    while (!quit){
        SDL_EnableKeyRepeat(0,0);
        menu_loop(screen, &game, &ranking, &quit);

        /*Játék ciklus*/
        level = 1;
        while(game){
            SDL_EnableKeyRepeat(1,60);
            //Adott pálya betöltése
            loadlevel(&boxpos, &charpos, &lab1, level);
            game_event_loop(screen, &charpos, boxpos,&lab1, &game, &level);
        }
        /*Rangsor*/
        while(ranking){
            ranking_loop(screen, &ranking);
        }
    }

    /*Lefoglalt dolgok felszabadítása*/
    free(boxpos);
    SDL_FreeSurface(screen);
    freegame();
    freemenu();
    //freeranking();

    /* Ablak bezárása */
    SDL_Quit();

    return 0;
}
